<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SilverStrength v7</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff;
            --text: #0f172a; --text-light: #475569;
            --accent: #2563eb; --accent-light: #eff6ff;
            --success: #16a34a; --danger: #dc2626;
            --border: #cbd5e1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* TYPOGRAPHY */
        h1 { font-size: 1.8rem; font-weight: 800; margin: 0 0 5px 0; color: var(--text); }
        h2 { font-size: 1.4rem; font-weight: 700; margin: 25px 0 15px 0; border-bottom: 2px solid var(--accent); display: inline-block; }
        h3 { font-size: 1.1rem; font-weight: 600; color: var(--text-light); margin-bottom: 5px; }
        p { color: var(--text-light); line-height: 1.6; margin-top: 0; }

        /* CARDS & UI */
        .card { background: var(--card); border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 15px; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 10px; }
        .btn-primary { background: var(--text); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 2px solid var(--text); color: var(--text); }
        
        /* DASHBOARD */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--accent); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px auto; }
        .score-val { font-size: 2.5rem; font-weight: 900; color: var(--accent); line-height: 1; }
        .score-label { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }

        /* WEEKLY SCHEDULE LIST */
        .day-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); opacity: 0.6; }
        .day-row.active { opacity: 1; background: var(--accent-light); padding: 15px; border-radius: 10px; border-bottom: none; margin: 5px 0; border: 1px solid #bfdbfe; }
        .day-row.done { opacity: 1; }
        .day-row.done .status-icon { color: var(--success); }
        
        /* LIBRARY */
        .lib-item { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .lib-tag { background: #e2e8f0; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: bold; }
        .lib-benefit { background: #f0fdf4; border-left: 4px solid var(--success); padding: 10px; margin-top: 10px; font-size: 0.9rem; color: #14532d; }

        /* ACTIVE WORKOUT */
        #view-active { position: fixed; inset: 0; background: white; z-index: 100; overflow-y: auto; display: flex; flex-direction: column; }
        .active-header { padding: 15px; background: #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .timer-big { font-size: 5rem; font-weight: 900; text-align: center; color: var(--text); font-variant-numeric: tabular-nums; margin: 20px 0; }
        
        /* CUES & TEMPO */
        .cue-box { background: #fff7ed; border-left: 5px solid #f97316; padding: 15px; margin: 20px 0; }
        .cue-list { padding-left: 20px; margin: 0; line-height: 1.6; }
        
        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 50; }
        .nav-btn { flex: 1; border: none; background: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.75rem; font-weight: 600; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn i { font-size: 1.5rem; margin-bottom: 4px; }
        
        .std-input { width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="view-onboarding" class="container hidden" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <h1 style="text-align:center;">SilverStrength</h1>
        <p style="text-align:center; margin-bottom:30px;">Structured weekly plans for weight loss.</p>
        <label><b>First Name</b></label>
        <input type="text" id="inp-name" class="std-input">
        <label><b>Current Weight (lbs)</b></label>
        <input type="number" id="inp-weight" class="std-input">
        <button class="btn btn-accent" onclick="finishOnboarding()">Create Weekly Schedule</button>
    </div>

    <div id="view-dashboard" class="container">
        <div class="header">
            <div>
                <h1 id="dash-greeting">Hello</h1>
                <p id="dash-date">Date</p>
            </div>
            <div style="background:var(--text); color:white; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user"></i></div>
        </div>

        <div id="sunday-card" class="card hidden" style="border: 2px solid var(--accent);">
            <h2 style="margin-top:0; border:none; text-align:center;">Weekly Report Card</h2>
            <div class="score-circle">
                <span class="score-val" id="week-score">0%</span>
                <span class="score-label">Adherence</span>
            </div>
            <p style="text-align:center;">Time to weigh in to unlock next week.</p>
            <input type="number" id="sunday-weight" class="std-input" placeholder="Weight (lbs)">
            <button class="btn btn-accent" onclick="completeWeek()">Log & Start New Week</button>
        </div>

        <div id="normal-dash">
            <div class="card" id="today-card">
                </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="card" style="text-align:center; padding:15px;">
                    <div style="font-size:1.5rem; font-weight:800; color:var(--text);" id="dash-weight">--</div>
                    <div style="font-size:0.7rem; font-weight:bold; text-transform:uppercase; color:var(--text-light);">Weight</div>
                </div>
                <div class="card" style="text-align:center; padding:15px;">
                    <div style="font-size:1.5rem; font-weight:800; color:var(--success);" id="dash-activity">0</div>
                    <div style="font-size:0.7rem; font-weight:bold; text-transform:uppercase; color:var(--text-light);">Mins This Week</div>
                </div>
            </div>

            <h3>Log Extra Activity</h3>
            <div class="card">
                <div style="display:flex; gap:10px;">
                    <select id="ext-type" class="std-input" style="margin:0; flex:2;">
                        <option>Walking</option><option>Golf</option><option>Swimming</option><option>Pickleball</option><option>Gardening</option>
                    </select>
                    <input type="number" id="ext-mins" class="std-input" placeholder="Min" style="margin:0; flex:1;">
                </div>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="logExternal()">Log Activity</button>
            </div>
        </div>
    </div>

    <div id="view-schedule" class="container hidden">
        <div class="header">
            <h1>This Week</h1>
            <button class="btn btn-primary" style="width:auto; padding:8px 15px; font-size:0.8rem;" onclick="exportCalendar()">
                <i class="fas fa-calendar-export"></i> Export
            </button>
        </div>
        <div class="card" id="week-list">
            </div>
    </div>

    <div id="view-library" class="container hidden">
        <h1>Exercise Guide</h1>
        <p>Detailed breakdown and benefits.</p>
        <div class="card" id="lib-list">
            </div>
    </div>

    <div id="view-active" class="hidden">
        <div class="active-header">
            <button class="btn btn-outline" style="width:auto; margin:0; padding:8px 15px;" onclick="quitWorkout()">Quit</button>
            <strong id="act-routine">Routine</strong>
            <div style="width:60px"></div>
        </div>
        <div style="padding:20px; padding-bottom:100px;">
            <div style="text-align:center;">
                <span class="lib-tag">Exercise <span id="act-idx">1</span></span>
                <h1 id="act-name" style="margin-top:10px; font-size:2.2rem;">Name</h1>
            </div>

            <div id="act-viz"></div>

            <div class="cue-box">
                <strong><i class="fas fa-check-circle"></i> Perfect Form</strong>
                <ul id="act-cues" class="cue-list"></ul>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div style="background:#f1f5f9; padding:10px; border-radius:10px; text-align:center;">
                    <small>TEMPO</small>
                    <div id="act-tempo" style="font-weight:bold;">2-0-2</div>
                </div>
                <div style="background:#f1f5f9; padding:10px; border-radius:10px; text-align:center;">
                    <small>BREATH</small>
                    <div id="act-breath" style="font-weight:bold;">Exhale Up</div>
                </div>
            </div>

            <button class="btn btn-success" id="act-btn" style="margin-top:20px; padding:20px; font-size:1.2rem;" onclick="nextExercise()">Start</button>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i>Home</button>
        <button class="nav-btn" onclick="switchTab('schedule')"><i class="fas fa-calendar-week"></i>Schedule</button>
        <button class="nav-btn" onclick="switchTab('library')"><i class="fas fa-book-open"></i>Guide</button>
    </div>

    <script>
        /* --- 1. DATA --- */
        const library = {
            "Metabolic March": {
                desc: "A high-intensity variation of marching in place. Knees must go high, arms must swing vigorously.",
                steps: ["Stand tall, feet hip-width.", "Lift right knee to hip height.", "Simultaneously swing left arm cheek-to-cheek.", "Switch rapidly but smoothly.", "Land softly on balls of feet."],
                benefit: "Safely elevates heart rate to burn calories without the joint impact of running. Improves coordination.",
                type: "time", val: 60, tempo: "Fast Rhythm", breath: "Rhythmic (In-In-Out-Out)"
            },
            "Chair Squats": {
                desc: "Sitting down and standing up from a chair without using hands.",
                steps: ["Stand in front of sturdy chair.", "Feet shoulder-width apart.", "Lower hips back until you tap the seat.", "Drive through heels to stand up explosively.", "Keep chest up throughout."],
                benefit: "Crucial for longevity. Strengthens quads and glutes to protect knees and ensure independence.",
                type: "reps", val: 12, tempo: "3s Down, 1s Up", breath: "Inhale Down, Exhale Up"
            },
            "Wall Push-ups": {
                desc: "A push-up performed against a wall to reduce gravity load.",
                steps: ["Stand arm-length from wall.", "Hands at chest height, shoulder-width.", "Keep body straight (no sagging hips).", "Lower nose to wall.", "Push back to start."],
                benefit: "Builds upper body bone density and chest strength without wrist strain.",
                type: "reps", val: 12, tempo: "2s Down, 1s Pause, 2s Up", breath: "Inhale Down, Exhale Push"
            },
            "Doorway Rows": {
                desc: "Using a doorframe to perform a pulling motion.",
                steps: ["Stand in open doorway.", "Grip frame with both hands.", "Lean back, straightening arms.", "Pull chest through the frame squeezing shoulder blades.", "Control the release back."],
                benefit: "Fixes 'slumped' posture by strengthening upper back. Counteracts gravity's pull.",
                type: "reps", val: 15, tempo: "1s Pull, 2s Squeeze, 3s Release", breath: "Exhale Pull, Inhale Release"
            },
            "Glute Bridges": {
                desc: "Lying on back, lifting hips.",
                steps: ["Lie on back, knees bent, feet flat.", "Press heels into floor.", "Lift hips until body is a straight line from shoulder to knee.", "Squeeze glutes hard at top.", "Lower slowly."],
                benefit: "Directly targets glutes to support the lower back and prevent hip pain.",
                type: "reps", val: 15, tempo: "1s Up, 2s Squeeze, 2s Down", breath: "Exhale Up, Inhale Down"
            },
            "Bird Dog": {
                desc: "On hands and knees, extending opposite limbs.",
                steps: ["Start on all fours, back flat.", "Extend right arm forward and left leg back.", "Hold for 2 seconds without rotating hips.", "Return and switch sides."],
                benefit: "The gold standard for core stability and spinal health. Prevents back injuries.",
                type: "reps", val: 10, tempo: "Slow & Controlled", breath: "Exhale Extend, Inhale Return"
            }
        };

        const routines = {
            'Strength A': { type: 'Strength', duration: 25, exercises: ["Chair Squats", "Wall Push-ups", "Metabolic March", "Glute Bridges", "Doorway Rows"] },
            'Cardio B': { type: 'Cardio', duration: 20, exercises: ["Metabolic March", "Chair Squats", "Metabolic March", "Doorway Rows", "Metabolic March"] },
            'Mobility C': { type: 'Mobility', duration: 15, exercises: ["Glute Bridges", "Bird Dog", "Doorway Rows", "Metabolic March"] }
        };

        /* --- 2. STATE --- */
        let appState = {
            user: { name: "", weight: 0 },
            weekPlan: [], // [{date, day, routineKey, completed, type}]
            logs: [],
            onboarded: false
        };

        let audioCtx = null;

        /* --- 3. LOGIC --- */
        window.onload = () => {
            const saved = localStorage.getItem('SilverStrength_v7');
            if(saved) appState = JSON.parse(saved);

            if(!appState.onboarded) document.getElementById('view-onboarding').classList.remove('hidden');
            else {
                checkWeeklyPlan();
                initApp();
            }
        };

        function save() { localStorage.setItem('SilverStrength_v7', JSON.stringify(appState)); }

        function finishOnboarding() {
            const n = document.getElementById('inp-name').value;
            const w = document.getElementById('inp-weight').value;
            if(!n||!w) return alert("Required");
            appState.user.name = n;
            appState.user.weight = w;
            appState.onboarded = true;
            generateWeek();
            save();
            document.getElementById('view-onboarding').classList.add('hidden');
            initApp();
        }

        // GENERATE FIXED WEEKLY SCHEDULE
        function generateWeek() {
            // Logic: Mon=Strength, Tue=Cardio, Wed=Mobility, Thu=Strength, Fri=Cardio, Sat=Active, Sun=Rest
            const plan = [];
            const today = new Date();
            // Align to Monday if possible, or just start today for v1 simplicity
            // Let's just generate next 7 days starting today
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            
            for(let i=0; i<7; i++) {
                let d = new Date();
                d.setDate(today.getDate() + i);
                let dayNum = d.getDay();
                let rKey = null;

                if(dayNum === 1 || dayNum === 4) rKey = 'Strength A';
                else if(dayNum === 2 || dayNum === 5) rKey = 'Cardio B';
                else if(dayNum === 3 || dayNum === 6) rKey = 'Mobility C';
                // Sun (0) is rest, null key

                plan.push({
                    date: d.toISOString().split('T')[0],
                    dayName: days[dayNum],
                    routineKey: rKey,
                    completed: false
                });
            }
            appState.weekPlan = plan;
        }

        function checkWeeklyPlan() {
            // If plan is empty or old, handle it.
            // For this strict version, we check if today is > last day of plan
            if(!appState.weekPlan.length) generateWeek();
            else {
                const lastDate = new Date(appState.weekPlan[6].date);
                const today = new Date();
                // If today is way past the plan, reset
                if(today > lastDate && today.toDateString() !== lastDate.toDateString()) {
                   // Ideally we force a sunday review, but for failsafe:
                   generateWeek(); 
                }
            }
        }

        function initApp() {
            document.getElementById('dash-greeting').innerText = `Hello, ${appState.user.name}`;
            document.getElementById('dash-date').innerText = new Date().toDateString();
            document.getElementById('dash-weight').innerText = appState.user.weight;
            
            // Calculate Total Activity
            const total = appState.logs.reduce((acc,cur) => acc + cur.duration, 0);
            document.getElementById('dash-activity').innerText = total;

            renderDashboard();
            renderSchedule();
            renderLibrary();
        }

        function switchTab(t) {
            document.querySelectorAll('.container').forEach(c=>c.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            
            const map = {'dashboard':0, 'schedule':1, 'library':2};
            document.querySelectorAll('.nav-btn')[map[t]].classList.add('active');
        }

        /* --- DASHBOARD LOGIC --- */
        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const dayNum = new Date().getDay();

            // Sunday Check
            if(dayNum === 0) {
                document.getElementById('normal-dash').classList.add('hidden');
                document.getElementById('sunday-card').classList.remove('hidden');
                
                // Calc Score
                const scheduled = appState.weekPlan.filter(d => d.routineKey).length;
                const done = appState.weekPlan.filter(d => d.completed).length;
                const score = scheduled === 0 ? 100 : Math.round((done/scheduled)*100);
                document.getElementById('week-score').innerText = score + "%";
            } else {
                document.getElementById('normal-dash').classList.remove('hidden');
                document.getElementById('sunday-card').classList.add('hidden');

                // Today's Task
                const task = appState.weekPlan.find(d => d.date === todayStr);
                const container = document.getElementById('today-card');
                
                if(!task) {
                    container.innerHTML = "<h3>Planning...</h3>";
                    return;
                }

                if(!task.routineKey) {
                    container.innerHTML = `
                        <h2>Rest Day</h2>
                        <p>Relax and recover. Light walking is allowed.</p>
                        <div style="background:#f0fdf4; color:#166534; padding:10px; border-radius:10px; text-align:center;">
                            <i class="fas fa-couch"></i> Active Recovery
                        </div>
                    `;
                } else if(task.completed) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:20px;">
                            <i class="fas fa-check-circle" style="font-size:4rem; color:var(--success);"></i>
                            <h2>Complete!</h2>
                            <p>Great job today.</p>
                        </div>
                    `;
                } else {
                    const r = routines[task.routineKey];
                    container.innerHTML = `
                        <h3 style="text-transform:uppercase; font-size:0.8rem;">Today's Priority</h3>
                        <h2 style="margin-top:5px; border:none;">${task.routineKey}</h2>
                        <p>${r.exercises.length} Exercises • ${r.duration} Mins</p>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <span class="lib-tag" style="background:#dbeafe; color:#1e40af">${r.type}</span>
                            <span class="lib-tag">Weight Loss</span>
                        </div>
                        <button class="btn btn-accent" onclick="startWorkout('${task.routineKey}')">Start Workout</button>
                    `;
                }
            }
        }

        function completeWeek() {
            const w = document.getElementById('sunday-weight').value;
            if(!w) return alert("Please log weight.");
            appState.user.weight = w;
            appState.logs.push({date: new Date().toISOString(), duration: 0, type: 'Weigh In'});
            // Generate NEW week
            generateWeek();
            save();
            location.reload(); // Refresh to reset view
        }

        function logExternal() {
            const mins = parseFloat(document.getElementById('ext-mins').value);
            if(!mins) return;
            appState.logs.push({
                date: new Date().toISOString(),
                duration: mins,
                type: document.getElementById('ext-type').value
            });
            save();
            alert("Activity Logged!");
            initApp();
        }

        /* --- SCHEDULE & EXPORT --- */
        function renderSchedule() {
            const list = document.getElementById('week-list');
            list.innerHTML = "";
            const todayStr = new Date().toISOString().split('T')[0];

            appState.weekPlan.forEach(day => {
                const isToday = day.date === todayStr;
                const status = day.completed ? '<i class="fas fa-check-circle status-icon"></i>' : (day.routineKey ? '<i class="far fa-circle"></i>' : '-');
                const title = day.routineKey || "Rest Day";
                
                list.innerHTML += `
                    <div class="day-row ${isToday?'active':''} ${day.completed?'done':''}">
                        <div style="width:50px; text-align:center;">
                            <div style="font-weight:bold; font-size:0.8rem; text-transform:uppercase;">${day.dayName}</div>
                            <div style="font-size:0.7rem;">${day.date.slice(5)}</div>
                        </div>
                        <div style="flex:1; padding-left:15px;">
                            <div style="font-weight:bold;">${title}</div>
                            <div style="font-size:0.8rem; color:var(--text-light);">
                                ${day.routineKey ? routines[day.routineKey].duration + ' mins • ' + routines[day.routineKey].type : 'Recovery'}
                            </div>
                        </div>
                        <div style="font-size:1.5rem; color:#cbd5e1;">${status}</div>
                    </div>
                `;
            });
        }

        function exportCalendar() {
            let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SilverStrength//EN\n";
            
            appState.weekPlan.forEach(day => {
                if(!day.routineKey) return;
                const r = routines[day.routineKey];
                
                // Format Date: YYYYMMDD
                const dStr = day.date.replace(/-/g, '');
                // Set fixed time 9:00 AM
                const start = `${dStr}T090000`;
                const end = `${dStr}T09${r.duration}00`;
                
                ics += "BEGIN:VEVENT\n";
                ics += `DTSTART:${start}\nDTEND:${end}\n`;
                ics += `SUMMARY:SilverStrength: ${day.routineKey}\n`;
                ics += `DESCRIPTION:Type: ${r.type} \\nLength: ${r.duration} minutes.\n`;
                ics += "END:VEVENT\n";
            });

            ics += "END:VCALENDAR";
            
            const blob = new Blob([ics], {type:'text/calendar'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'silverstrength_plan.ics';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        /* --- LIBRARY --- */
        function renderLibrary() {
            const list = document.getElementById('lib-list');
            list.innerHTML = "";
            for(let key in library) {
                const ex = library[key];
                list.innerHTML += `
                    <div class="lib-item">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>${key}</h3>
                            <span class="lib-tag">${ex.type}</span>
                        </div>
                        <p>${ex.desc}</p>
                        <ul style="padding-left:20px; color:var(--text-light); font-size:0.9rem;">
                            ${ex.steps.map(s=>`<li>${s}</li>`).join('')}
                        </ul>
                        <div class="lib-benefit"><i class="fas fa-heartbeat"></i> <b>Why:</b> ${ex.benefit}</div>
                    </div>
                `;
            }
        }

        /* --- ACTIVE WORKOUT --- */
        let activeR = null;
        let actIdx = 0;
        let timer = null;
        let timerVal = 0;
        let isPaused = false;

        function startWorkout(key) {
            activeR = routines[key];
            actIdx = 0;
            document.getElementById('view-active').classList.remove('hidden');
            document.getElementById('act-routine').innerText = key;
            loadEx();
        }

        function loadEx() {
            if(actIdx >= activeR.exercises.length) return finishWorkout();
            
            const name = activeR.exercises[actIdx];
            const data = library[name];
            
            document.getElementById('act-name').innerText = name;
            document.getElementById('act-idx').innerText = actIdx+1;
            
            // Cues
            document.getElementById('act-cues').innerHTML = data.steps.map(s=>`<li>${s}</li>`).join('');
            document.getElementById('act-tempo').innerText = data.tempo;
            document.getElementById('act-breath').innerText = data.breath;

            const viz = document.getElementById('act-viz');
            const btn = document.getElementById('act-btn');
            clearInterval(timer);

            if(data.type === 'reps') {
                viz.innerHTML = `<div class="timer-big" style="color:var(--accent)">${data.val}<span style="font-size:2rem;color:var(--text-light)">reps</span></div>`;
                btn.innerText = "Check Complete";
                btn.className = "btn btn-success";
                btn.onclick = nextExercise;
            } else {
                timerVal = data.val;
                isPaused = false;
                viz.innerHTML = `<div class="timer-big" id="timer-val">00:${timerVal}</div>`;
                btn.innerText = "Start Timer";
                btn.className = "btn btn-primary";
                btn.onclick = toggleTimer;
            }
        }

        function toggleTimer() {
            const btn = document.getElementById('act-btn');
            if(btn.innerText === "Start Timer") {
                btn.innerText = "Pause";
                if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
                startLoop();
            } else if(btn.innerText === "Pause") {
                isPaused = true;
                btn.innerText = "Resume";
            } else {
                isPaused = false;
                btn.innerText = "Pause";
            }
        }

        function startLoop() {
            timer = setInterval(() => {
                if(!isPaused) {
                    timerVal--;
                    document.getElementById('timer-val').innerText = `00:${timerVal.toString().padStart(2,'0')}`;
                    if(timerVal <= 0) {
                        clearInterval(timer);
                        playChime();
                        nextExercise();
                    }
                }
            }, 1000);
        }

        function playChime() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = 440;
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1.5);
            osc.start(); osc.stop(audioCtx.currentTime+1.5);
        }

        function nextExercise() { actIdx++; loadEx(); }

        function quitWorkout() {
            if(confirm("Quit?")) {
                clearInterval(timer);
                document.getElementById('view-active').classList.add('hidden');
            }
        }

        function finishWorkout() {
            clearInterval(timer);
            document.getElementById('view-active').classList.add('hidden');
            
            // Mark Today Complete
            const todayStr = new Date().toISOString().split('T')[0];
            const task = appState.weekPlan.find(d => d.date === todayStr);
            if(task) task.completed = true;

            appState.logs.push({date: new Date().toISOString(), duration: 20, type: 'Workout'});
            save();
            initApp();
            alert("Workout Complete!");
        }

    </script>
</body>
</html>
