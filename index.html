<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SilverStrength AI v6</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* HIGH CONTRAST PALETTE */
            --bg: #f1f5f9;            /* Light Grey Background */
            --card: #ffffff;          /* Pure White Cards */
            --primary: #1e293b;       /* Very Dark Slate (Text) */
            --primary-light: #475569; /* Medium Slate (Subtext) */
            --accent: #2563eb;        /* Bright Blue */
            --accent-bg: #eff6ff;     /* Very Light Blue */
            --success: #16a34a;       /* Green */
            --border: #cbd5e1;        /* Distinct Borders */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 0;
            padding-bottom: 100px; /* Space for nav */
            height: 100vh;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }

        /* TYPOGRAPHY - INCREASED FOR READABILITY */
        h1 { font-size: 1.8rem; font-weight: 800; margin: 0 0 5px 0; color: var(--primary); }
        h2 { font-size: 1.4rem; font-weight: 700; margin: 25px 0 15px 0; color: var(--primary); border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; }
        h3 { font-size: 1.1rem; font-weight: 600; margin: 0 0 10px 0; color: var(--primary-light); }
        p { color: var(--primary-light); line-height: 1.6; font-size: 1rem; margin-top: 0; }

        /* CARDS */
        .card {
            background: var(--card); border-radius: 16px; padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        /* BUTTONS - HIGH VISIBILITY */
        .btn { width: 100%; padding: 18px; border-radius: 12px; border: none; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.2s; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        
        /* DASHBOARD GRID */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--accent); }
        .stat-lbl { font-size: 0.8rem; font-weight: 700; color: var(--primary-light); text-transform: uppercase; }

        /* AI RECOMMENDATION BOX */
        .ai-box {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            color: white; border-radius: 16px; padding: 25px; position: relative;
        }
        .ai-badge {
            background: var(--accent); font-size: 0.8rem; padding: 6px 12px; border-radius: 20px;
            text-transform: uppercase; font-weight: bold; display: inline-block; margin-bottom: 15px;
        }
        .ai-text { color: #e2e8f0; font-size: 1rem; margin-bottom: 20px; }

        /* SCHEDULE & LISTS */
        .schedule-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--border); align-items: center; }
        .schedule-date { font-weight: bold; color: var(--primary); width: 60px; text-align: center; line-height: 1.2; }
        .schedule-task { flex: 1; margin-left: 15px; }
        .tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .tag-strength { background: #fee2e2; color: #991b1b; }
        .tag-cardio { background: #dbeafe; color: #1e40af; }
        .tag-mobility { background: #dcfce7; color: #166534; }

        /* ACTIVE WORKOUT */
        #view-active {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #ffffff;
            z-index: 100; overflow-y: auto; display: flex; flex-direction: column;
        }
        .active-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .timer-display { font-size: 5rem; font-weight: 900; color: var(--primary); text-align: center; margin: 20px 0; font-variant-numeric: tabular-nums; }
        
        /* FORM CHECK CUES */
        .cue-box { background: #f0f9ff; border-left: 6px solid var(--accent); padding: 15px; margin: 20px 0; border-radius: 0 12px 12px 0; }
        .cue-list { margin: 0; padding-left: 20px; font-size: 1.05rem; line-height: 1.6; }

        /* NAV BAR */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: white; border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 50;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; border: none; background: none;
            color: var(--primary-light); font-size: 0.75rem; font-weight: 600; cursor: pointer; width: 100%;
        }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.5rem; margin-bottom: 5px; }

        /* ONBOARDING */
        #view-onboarding { position: fixed; inset: 0; background: white; z-index: 200; padding: 30px; display: flex; flex-direction: column; justify-content: center; }
        .std-input { width: 100%; padding: 16px; margin-bottom: 20px; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="view-onboarding" class="hidden">
        <h1 style="text-align: center;">SilverStrength AI</h1>
        <p style="text-align: center; margin-bottom: 40px;">Smart, high-contrast, personalized.</p>
        <label><b>First Name</b></label>
        <input type="text" id="inp-name" class="std-input" placeholder="e.g. James">
        <label><b>Current Weight (lbs)</b></label>
        <input type="number" id="inp-weight" class="std-input" placeholder="e.g. 200">
        <button class="btn btn-accent" onclick="finishOnboarding()">Start My Journey</button>
    </div>

    <div id="view-dashboard" class="container">
        <div class="header">
            <div>
                <h1 id="dash-greeting">Hello</h1>
                <p id="dash-date" style="font-weight: 600;">Date</p>
            </div>
            <div style="background:var(--primary); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                <i class="fas fa-user"></i>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-val" id="dash-weight">--</div>
                <div class="stat-lbl">Weight (lbs)</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="dash-activity">0</div>
                <div class="stat-lbl">Weekly Mins</div>
            </div>
        </div>

        <div id="ai-rec-container"></div>

        <h2><i class="fas fa-plus-circle"></i> Log External Activity</h2>
        <div class="card">
            <p>Did you exercise outside the app?</p>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <select id="ext-type" class="std-input" style="margin:0; flex:2;">
                    <option value="Walking">Walking</option>
                    <option value="Golf">Golf</option>
                    <option value="Swimming">Swimming</option>
                    <option value="Cycling">Cycling</option>
                    <option value="Gardening">Gardening</option>
                    <option value="Tennis">Tennis</option>
                </select>
                <input type="number" id="ext-mins" class="std-input" placeholder="Mins" style="margin:0; flex:1;">
            </div>
            <button class="btn btn-outline" onclick="logExternalActivity()">Log Activity</button>
        </div>
    </div>

    <div id="view-schedule" class="container hidden">
        <div class="header">
            <h1>Future Plan</h1>
            <button class="btn btn-primary" style="width: auto; padding: 10px 15px; font-size: 0.9rem;" onclick="exportToCalendar()">
                <i class="fas fa-calendar-plus"></i> Export to Apple Cal
            </button>
        </div>
        <div class="card" id="schedule-list">
            </div>
        <p style="font-size:0.9rem; text-align:center;">
            <i class="fas fa-info-circle"></i> This schedule adapts based on your fatigue.
        </p>
    </div>

    <div id="view-tracker" class="container hidden">
        <h1>Progress Tracker</h1>
        <div class="card">
            <canvas id="weightChart" style="height:250px;"></canvas>
        </div>
        <h2>Add Weight Log</h2>
        <div class="card" style="display:flex; gap:10px;">
            <input type="number" id="weight-input" class="std-input" style="margin:0;" placeholder="lbs">
            <button class="btn btn-primary" style="width:auto;" onclick="logWeight()">Save</button>
        </div>
        <h2>History</h2>
        <div class="card" id="history-list"></div>
    </div>

    <div id="view-active" class="hidden">
        <div class="active-header">
            <button class="btn btn-outline" style="width:auto; padding:8px 15px; margin:0;" onclick="quitWorkout()">Quit</button>
            <strong id="act-routine-title" style="font-size:1.1rem;">Routine</strong>
            <div style="width:60px"></div>
        </div>

        <div style="padding: 20px; padding-bottom: 120px;">
            <div style="text-align: center;">
                <span style="background: var(--primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;">EXERCISE <span id="act-index">1</span></span>
                <h1 id="act-name" style="font-size: 2.2rem; line-height: 1.1; margin-top: 15px;">Name</h1>
            </div>

            <div id="act-viz"></div>

            <div class="cue-box">
                <div style="color:var(--accent); font-weight:bold; text-transform:uppercase; font-size:0.85rem; margin-bottom:10px;">
                    <i class="fas fa-check-circle"></i> Perfect Form
                </div>
                <ul id="act-cues" class="cue-list"></ul>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
                <div style="background: #f8fafc; padding:15px; border-radius:12px; text-align:center; border:1px solid var(--border);">
                    <div style="font-size:0.75rem; font-weight:bold; color:var(--primary-light); text-transform:uppercase;">Tempo</div>
                    <div id="act-tempo" style="font-weight:bold; color:var(--primary); font-size:1.1rem;">2-0-2</div>
                </div>
                <div style="background: #f8fafc; padding:15px; border-radius:12px; text-align:center; border:1px solid var(--border);">
                    <div style="font-size:0.75rem; font-weight:bold; color:var(--primary-light); text-transform:uppercase;">Breathing</div>
                    <div id="act-breath" style="font-weight:bold; color:var(--primary); font-size:1.1rem;">Exhale Up</div>
                </div>
            </div>

            <button class="btn btn-success" id="act-btn" style="margin-top: 30px; box-shadow: 0 10px 20px rgba(22, 163, 74, 0.3);" onclick="nextExercise()">Start Exercise</button>
        </div>
    </div>

    <div class="nav-bar">
        <button class="nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i>Home</button>
        <button class="nav-item" onclick="switchTab('schedule')"><i class="fas fa-calendar-alt"></i>Plan</button>
        <button class="nav-item" onclick="switchTab('tracker')"><i class="fas fa-chart-line"></i>Track</button>
    </div>

    <script>
        /* --- 1. CONFIG & DATA --- */
        const library = {
            "Metabolic March": { type: "time", val: 60, cues: ["Knees up to hip height", "Pump arms cheek-to-cheek", "Keep chest tall"], tempo: "Fast & Rhythmic", breath: "Inhale 2 steps, Exhale 2 steps" },
            "Chair Squats": { type: "reps", val: 12, cues: ["Tap glutes to chair, don't sit", "Weight in heels", "Chest up"], tempo: "3s Down, 1s Up (Fast)", breath: "Inhale down, Exhale up" },
            "Wall Push-ups": { type: "reps", val: 12, cues: ["Body in straight plank line", "Hands chest height", "Elbows tucked 45Â°"], tempo: "2s Down, 1s Pause, 2s Up", breath: "Inhale down, Exhale push" },
            "Sit-to-Stand": { type: "time", val: 45, cues: ["Full sit, Full stand", "Don't use hands if possible", "Constant motion"], tempo: "Steady Pace", breath: "Rhythmic" },
            "Doorway Rows": { type: "reps", val: 15, cues: ["Hold doorframe, lean back", "Squeeze shoulder blades", "Keep hips straight"], tempo: "1s Pull, 2s Squeeze, 3s Back", breath: "Exhale pull, Inhale back" },
            "Glute Bridges": { type: "reps", val: 15, cues: ["Lift hips to ceiling", "Squeeze glutes hard", "Push through heels"], tempo: "1s Up, 2s Hold, 2s Down", breath: "Exhale up, Inhale down" },
            "Bird Dog": { type: "reps", val: 10, cues: ["Extend opposite arm/leg", "Keep back flat like table", "Don't rotate hips"], tempo: "Slow & Controlled", breath: "Exhale extend, Inhale return" }
        };

        const routines = {
            'morning': { title: "Morning Metabolism", type: "Cardio", exercises: ["Metabolic March", "Sit-to-Stand", "Metabolic March", "Doorway Rows"] },
            'strength': { title: "Full Body Strength", type: "Strength", exercises: ["Chair Squats", "Wall Push-ups", "Metabolic March", "Glute Bridges", "Doorway Rows"] },
            'mobility': { title: "Active Recovery", type: "Mobility", exercises: ["Glute Bridges", "Doorway Rows", "Metabolic March", "Bird Dog"] }
        };

        let appState = {
            user: { name: "", weight: 0 },
            logs: [], // { date: ISO, type: 'App'|'External', name: 'Strength', duration: 20 }
            weightLog: [],
            onboarded: false
        };

        let audioCtx = null; // For calming noise

        /* --- 2. INIT & NAV --- */
        window.onload = () => {
            const saved = localStorage.getItem('SilverStrength_v6');
            if(saved) appState = JSON.parse(saved);
            
            if(!appState.onboarded) document.getElementById('view-onboarding').classList.remove('hidden');
            else initApp();
        };

        function saveData() { localStorage.setItem('SilverStrength_v6', JSON.stringify(appState)); }

        function finishOnboarding() {
            const n = document.getElementById('inp-name').value;
            const w = document.getElementById('inp-weight').value;
            if(!n || !w) return alert("Please fill all fields");
            appState.user.name = n;
            appState.user.weight = parseFloat(w);
            appState.weightLog.push({ date: new Date().toISOString().split('T')[0], weight: parseFloat(w) });
            appState.onboarded = true;
            saveData();
            document.getElementById('view-onboarding').classList.add('hidden');
            initApp();
        }

        function initApp() {
            document.getElementById('dash-greeting').innerText = `Hello, ${appState.user.name}`;
            document.getElementById('dash-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            updateDashboard();
        }

        function switchTab(tab) {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            
            const map = { 'dashboard':0, 'schedule':1, 'tracker':2 };
            document.querySelectorAll('.nav-item')[map[tab]].classList.add('active');

            if(tab === 'dashboard') updateDashboard();
            if(tab === 'schedule') renderSchedule();
            if(tab === 'tracker') renderTracker();
        }

        /* --- 3. ALGORITHM & DASHBOARD --- */
        function calculateWeeklyActivity() {
            // Sum logs from last 7 days
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - 7);
            return appState.logs
                .filter(l => new Date(l.date) >= cutoff)
                .reduce((acc, curr) => acc + curr.duration, 0);
        }

        function updateDashboard() {
            document.getElementById('dash-weight').innerText = appState.user.weight;
            const weeklyMins = calculateWeeklyActivity();
            document.getElementById('dash-activity').innerText = weeklyMins;

            // --- SMART ALGORITHM ---
            const today = new Date().toISOString().split('T')[0];
            const hour = new Date().getHours();
            
            // 1. Calculate Daily Fatigue
            const dailyLogs = appState.logs.filter(l => l.date === today);
            const dailyMins = dailyLogs.reduce((acc, curr) => acc + curr.duration, 0);

            const aiContainer = document.getElementById('ai-rec-container');
            let recHTML = "";

            if (dailyMins > 45) {
                // User has done a lot today (External or App)
                recHTML = `
                    <div class="ai-box" style="background:linear-gradient(145deg, #166534 0%, #15803d 100%);">
                        <div class="ai-badge" style="background:#dcfce7; color:#166534;">High Activity Detected</div>
                        <h2 style="color:white; margin-top:0; border:none;">Recovery Recommended</h2>
                        <p class="ai-text">You've logged ${dailyMins} mins today. Great job! Let's focus on recovery to prevent fatigue.</p>
                        <button class="btn btn-outline" style="background:white; color:#166534; border:none;" onclick="startRoutine('mobility')">Start Mobility Flow</button>
                    </div>
                `;
            } else {
                // Standard Time-Based Logic
                if (hour < 11) {
                    recHTML = `
                        <div class="ai-box">
                            <div class="ai-badge">Morning Protocol</div>
                            <h2 style="color:white; margin-top:0; border:none;">Metabolic Boost</h2>
                            <p class="ai-text">Jumpstart your calorie burning for the day with this interval session.</p>
                            <button class="btn btn-accent" onclick="startRoutine('morning')">Start Routine</button>
                        </div>`;
                } else if (hour >= 11 && hour < 18) {
                    recHTML = `
                        <div class="ai-box">
                            <div class="ai-badge">Peak Strength Time</div>
                            <h2 style="color:white; margin-top:0; border:none;">Full Body Strength</h2>
                            <p class="ai-text">Your body temp is ideal for building muscle now.</p>
                            <button class="btn btn-accent" onclick="startRoutine('strength')">Start Routine</button>
                        </div>`;
                } else {
                    recHTML = `
                        <div class="ai-box">
                            <div class="ai-badge">Evening Wind Down</div>
                            <h2 style="color:white; margin-top:0; border:none;">Active Recovery</h2>
                            <p class="ai-text">Gentle movement to aid sleep and digestion.</p>
                            <button class="btn btn-accent" onclick="startRoutine('mobility')">Start Routine</button>
                        </div>`;
                }
            }
            aiContainer.innerHTML = recHTML;
        }

        /* --- 4. LOGGING --- */
        function logExternalActivity() {
            const type = document.getElementById('ext-type').value;
            const mins = parseFloat(document.getElementById('ext-mins').value);
            if(!mins) return;
            
            appState.logs.push({
                date: new Date().toISOString().split('T')[0],
                type: 'External',
                name: type,
                duration: mins
            });
            saveData();
            document.getElementById('ext-mins').value = "";
            alert("Activity Logged! Algorithm updated.");
            updateDashboard();
        }

        function logWeight() {
            const val = parseFloat(document.getElementById('weight-input').value);
            if(!val) return;
            appState.user.weight = val;
            appState.weightLog.push({ date: new Date().toISOString().split('T')[0], weight: val });
            saveData();
            document.getElementById('weight-input').value = "";
            renderTracker();
        }

        /* --- 5. SCHEDULE & EXPORT --- */
        function renderSchedule() {
            const list = document.getElementById('schedule-list');
            list.innerHTML = "";
            const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const today = new Date();

            for(let i=0; i<7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                const dayName = days[d.getDay()];
                const dateNum = d.getDate();
                
                // Logic for future schedule
                let task = "Full Body Strength";
                let tagClass = "tag-strength";
                
                // Example Logic: Mon/Wed/Fri = Strength, Tue/Thu = Cardio, Sat = Ext, Sun = Rest
                if (d.getDay() === 1 || d.getDay() === 3 || d.getDay() === 5) {
                    task = "Full Body Strength"; tagClass = "tag-strength";
                } else if (d.getDay() === 2 || d.getDay() === 4) {
                    task = "Morning Metabolism"; tagClass = "tag-cardio";
                } else {
                    task = "Mobility / Active Rest"; tagClass = "tag-mobility";
                }

                list.innerHTML += `
                    <div class="schedule-row">
                        <div class="schedule-date">
                            <div style="font-size:0.8rem; text-transform:uppercase; color:var(--primary-light)">${dayName}</div>
                            <div style="font-size:1.2rem;">${dateNum}</div>
                        </div>
                        <div class="schedule-task">
                            <div style="font-weight:bold;">${task}</div>
                            <span class="tag ${tagClass}">${20} mins</span>
                        </div>
                    </div>
                `;
            }
        }

        function exportToCalendar() {
            // Generate ICS content
            let icsMsg = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SilverStrength//EN\n";
            const today = new Date();
            
            for(let i=0; i<7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                // Set time to 9am
                d.setHours(9,0,0,0);
                
                // Simple logic mapping
                let title = "SilverStrength Workout";
                if(d.getDay()%2 !== 0) title = "SilverStrength: Strength";
                else title = "SilverStrength: Cardio/Mobility";

                const dateStr = d.toISOString().replace(/[-:]/g,'').split('.')[0] + "Z";
                const endD = new Date(d.getTime() + 20*60000); // +20 mins
                const endStr = endD.toISOString().replace(/[-:]/g,'').split('.')[0] + "Z";

                icsMsg += "BEGIN:VEVENT\n";
                icsMsg += `DTSTART:${dateStr}\n`;
                icsMsg += `DTEND:${endStr}\n`;
                icsMsg += `SUMMARY:${title}\n`;
                icsMsg += "END:VEVENT\n";
            }
            icsMsg += "END:VCALENDAR";

            const blob = new Blob([icsMsg], { type: 'text/calendar' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'silverstrength_schedule.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /* --- 6. AUDIO ENGINE (Calming Chime) --- */
        function playCalmingChime() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.exponentialRampToValueAtTime(261.63, audioCtx.currentTime + 1.5); // Drop to C4

                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 2);
            } catch (e) {
                console.log("Audio play failed (interaction required first time)");
            }
        }

        /* --- 7. ACTIVE WORKOUT --- */
        let activeRoutine = null;
        let actIdx = 0;
        let timer = null;
        let timerVal = 0;
        let isPaused = false;

        function startRoutine(key) {
            activeRoutine = routines[key];
            activeRoutine.id = key;
            actIdx = 0;
            document.getElementById('view-active').classList.remove('hidden');
            document.getElementById('act-routine-title').innerText = activeRoutine.title;
            loadExercise();
        }

        function loadExercise() {
            if (actIdx >= activeRoutine.exercises.length) {
                finishWorkout();
                return;
            }
            const name = activeRoutine.exercises[actIdx];
            const data = library[name];
            
            document.getElementById('act-index').innerText = actIdx + 1;
            document.getElementById('act-name').innerText = name;
            
            // Cues
            document.getElementById('act-cues').innerHTML = data.cues.map(c => `<li>${c}</li>`).join('');
            document.getElementById('act-tempo').innerText = data.tempo;
            document.getElementById('act-breath').innerText = data.breath;

            const viz = document.getElementById('act-viz');
            const btn = document.getElementById('act-btn');
            clearInterval(timer);

            if (data.type === 'reps') {
                viz.innerHTML = `<div class="timer-display" style="color:var(--accent)">${data.val}<span style="font-size:2rem; color:var(--primary-light)"> reps</span></div>`;
                btn.innerText = "Completed";
                btn.className = "btn btn-success";
                btn.onclick = nextExercise;
            } else {
                timerVal = data.val;
                isPaused = false;
                viz.innerHTML = `<div class="timer-display" id="timer-val">00:${timerVal}</div>`;
                btn.innerText = "Start Timer";
                btn.className = "btn btn-primary";
                btn.onclick = toggleTimer;
            }
        }

        function toggleTimer() {
            const btn = document.getElementById('act-btn');
            if (btn.innerText === "Start Timer") {
                btn.innerText = "Pause";
                // Init audio context on first user click
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                startTimerLoop();
            } else if (btn.innerText === "Pause") {
                isPaused = true;
                btn.innerText = "Resume";
            } else {
                isPaused = false;
                btn.innerText = "Pause";
            }
        }

        function startTimerLoop() {
            timer = setInterval(() => {
                if (!isPaused) {
                    timerVal--;
                    document.getElementById('timer-val').innerText = `00:${timerVal.toString().padStart(2,'0')}`;
                    if (timerVal <= 0) {
                        clearInterval(timer);
                        playCalmingChime(); // Play Sound
                        nextExercise();
                    }
                }
            }, 1000);
        }

        function nextExercise() { actIdx++; loadExercise(); }

        function quitWorkout() {
            if(confirm("Stop workout?")) {
                clearInterval(timer);
                document.getElementById('view-active').classList.add('hidden');
            }
        }

        function finishWorkout() {
            clearInterval(timer);
            document.getElementById('view-active').classList.add('hidden');
            
            // Log App Workout
            appState.logs.push({
                date: new Date().toISOString().split('T')[0],
                type: 'App',
                name: activeRoutine.title,
                duration: 20 // Approx duration
            });
            saveData();
            alert("Workout Complete!");
            updateDashboard();
        }

        /* --- 8. TRACKER --- */
        function renderTracker() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const sortedLog = [...appState.weightLog].sort((a,b) => new Date(a.date) - new Date(b.date));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedLog.map(x => x.date),
                    datasets: [{ label: 'Weight', data: sortedLog.map(x => x.weight), borderColor: '#2563eb', tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // History List
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            const recent = [...appState.logs].reverse().slice(0,10);
            
            recent.forEach((log, index) => {
                list.innerHTML += `
                    <div class="schedule-row">
                        <div style="font-weight:bold;">${log.name}</div>
                        <div>
                            <span class="tag" style="background:${log.type==='App'?'#dbeafe':'#f3e8ff'}; color:${log.type==='App'?'#1e40af':'#6b21a8'}">${log.type}</span>
                            <span style="font-size:0.9rem;">${log.duration}m</span>
                            <i class="fas fa-trash" style="color:#ef4444; margin-left:10px; cursor:pointer;" onclick="deleteLog(${index})"></i>
                        </div>
                    </div>
                `;
            });
        }
        
        function deleteLog(index) {
            // Index passed is relative to the sliced reverse array
            // Real app would use IDs, simplified here:
            if(confirm("Remove this entry?")) {
                const realIndex = appState.logs.length - 1 - index;
                appState.logs.splice(realIndex, 1);
                saveData();
                renderTracker();
                updateDashboard();
            }
        }

    </script>
</body>
</html>
